<!DOCTYPE html>
<html>
<head>
    <title>Pitifall</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser-arcade-physics.min.js"></script>
    <link rel="shortcut icon" href="/croquetadef.ico" type="image/x-icon">
    <link rel="icon" href="/croquetadef.ico" type="image/x-icon">
</head>
<body>

    <script type="text/javascript">
    var config = {
        type: Phaser.AUTO,
        //width: 480,
        //height: 850,
        width: 1440,
        height: 2500,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: {y: 80},
                debut: false
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };
    
    var gravetat = 80;
    var limitEsquerra = 200;
    var limitDreta = 1240;
    var limitSuperior = 300;
    var movLateral = 30;

    //FORMATGES VIDA
    var ampladaFormatge = 175;
    var xFormatge = 450;
    var yFormatge = 210;
    var f1, f2, f3;

    //PILA CROQUETES
    var nCroquetes;
    const spritesEntrepa = ['entrepa0','entrepa1','entrepa2','entrepa3','entrepa4'];
    var yEntrepa = 1800;

    var entrepa;
    var croqueta;
    var terra;
    var fletxaDreta;
    var fletxaEsquerra;
    
    var cursors;

    var punts;
    var vides;

    var fotoPunts;
    var videsText;
    var fotoVides;

    var run = false;

    var game = new Phaser.Game(config);

    function preload ()
    {
        this.load.image('fons', 'assets/fons.png');
        this.load.image('formatge', 'assets/formatge.png');
        this.load.image('terra', 'assets/taula.png');
        this.load.image('fletxaDreta', 'assets/fletxaDreta.png');
        this.load.image('fletxaEsquerra', 'assets/fletxaEsquerra.png');
        this.load.image('tPunts', 'assets/textPunts.png');
        this.load.image('tVides', 'assets/textVides.png');
        this.load.image('croquetaQuieta', 'assets/croqueta_quieta.png')
        
        this.load.image('entrepa0', 'assets/entrepa.png');

        this.load.spritesheet('croqueta', 'assets/croqueta.png', { frameWidth: 120, frameHeight: 120});              
    }    

    function create ()     {
        //FONS
        this.add.image(0, 0, 'fons').setOrigin(0, 0);
        
        //FORMATGE VIDES
        f1 = this.add.image(xFormatge+0*ampladaFormatge, yFormatge, 'formatge');
        f2 = this.add.image(xFormatge+1*ampladaFormatge, yFormatge, 'formatge');
        f3 = this.add.image(xFormatge+2*ampladaFormatge, yFormatge, 'formatge');
        f1.setScale(2);
        f2.setScale(2);
        f3.setScale(2);

        //CROQUETA
        croqueta = this.physics.add.sprite(100, 200, 'croqueta');
        croqueta.setCollideWorldBounds(true); 
        
        //TERRA (perdre)
        terra = this.physics.add.staticGroup();
        terra.create(720, 2100, 'terra');

        //ENTREPÃ€
        entrepa = this.physics.add.sprite(720, yEntrepa, 'entrepa').setImmovable();
        entrepa.body.setAllowGravity(false); 
        entrepa.setScale(6);      

        //FLETXA DRETA
        fletxaDreta = this.add.sprite(1240, 2300, 'fletxaDreta').setInteractive();
        fletxaDreta.on('pointerdown', function () {            
            moureDreta();
        });

        fletxaDreta.setScale(3);

        //FLETXA ESQUERRA
        fletxaEsquerra = this.add.sprite(200, 2300, 'fletxaEsquerra').setInteractive();
        fletxaEsquerra.on('pointerdown', function () {            
            moureEsquerra();
        });

        fletxaEsquerra.setScale(3);

        //ANIMACIONS
        this.anims.create({
            key: 'croqueta',
            frames: this.anims.generateFrameNumbers('croqueta', { start: 0, end: 3 }),
            frameRate: 10,
            repeat: -1
        });        

        //CURSORS
        cursors = this.input.keyboard.createCursorKeys();        

        //COLLIDERS
        this.physics.add.collider(croqueta, terra, terraTocat);
        this.physics.add.collider(croqueta, entrepa, entrepaTocat);

        //TEXTS
        //puntsText = this.add.text(16, 16, 'Punts: 0', { fontSize: '64px', fill: '#000' });
        //videsText = this.add.text(16, 60, 'Vides: 3', { fontSize: '64px', fill: '#000' });
        fotoPunts = this.add.image(180, 60, 'tPunts');
        fotoVides = this.add.image(180, 210, 'tVides');
        puntsText = this.add.text(340, 15, '0', { fontSize: '128px', fill: '#000' });
        fotoPunts.setScale(2);
        fotoVides.setScale(2);

        inicialitzar();
        croqueta.anims.play('croqueta', true);
    }

    function update () {
        if (vides <= 0) {
            run = false;
            window.alert("has perdut");
        }        
    }

    function moureDreta () {
        if (entrepa.x <= limitDreta)
                entrepa.x += movLateral;
    }
    
    function moureEsquerra () {
        if (entrepa.x >= limitEsquerra)
                entrepa.x -= movLateral;
    }

    function inicialitzar () {
        vides = 3;
        punts = 0; 
        nCroquetes = 0;
        spawnCroqueta();
        run = true;
    }

    function spawnCroqueta () {
        croqueta.y = limitSuperior;
        croqueta.x = getRandomInt(limitEsquerra, limitDreta);
    }

    function esborrarVides () {
        if (vides == 2) {
            f3.visible = false;
        } else if (vides == 1) {
            f2.visible = false;
        } else if (vides == 0) {
            f1.visible = false;
        }
    }

    function terraTocat () {
        spawnCroqueta();

        vides -= 1;
        esborrarVides();

        gravetat += 10;
        croqueta.body.gravity.y = gravetat;
    }

    function dibuixarEntrepa () {
        entrepa.setTexture(spritesEntrepa[nCroquetes]);
    }

    function entrepaTocat () {
        spawnCroqueta();

        nCroquetes++;
        nCroquetes %= 5;
        dibuixarEntrepa();
    }   

    function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min)) + min;
    }
    </script>

</body>
</html>