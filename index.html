<!DOCTYPE html>
<html>
<head>
    <title>Pitifall</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser-arcade-physics.min.js"></script>
    <link rel="shortcut icon" href="/croquetadef.ico" type="image/x-icon">
    <link rel="icon" href="/croquetadef.ico" type="image/x-icon">
</head>
<body>

    <script type="text/javascript">
    var config = {
        type: Phaser.AUTO,
        //width: 480,
        //height: 850,
        width: 1440,
        height: 2500,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: {y: 80},
                debut: false
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };
    
    var gravetat = 80;
    var minGravetat = 100;
    var maxGravetat = 300;
    var limitEsquerra = 200;
    var limitDreta = 1240;
    var limitSuperior = 300;
    var movLateral = 40;

    //FORMATGES VIDA
    var ampladaFormatge = 175;
    var xFormatge = 450;
    var yFormatge = 210;
    var f1, f2, f3;

    var formatge;
    var countFormatge;
    var maxFormatge = 5;

    //PILA CROQUETES
    var nCroquetes;
    const spritesEntrepa = ['entrepa0','entrepa1','entrepa2','entrepa3','entrepa4'];
    var yEntrepa = 1560;

    var entrepa;
    var croqueta;
    var terra;
    var fletxaDreta;
    var fletxaEsquerra;
    var bomba;

    var timerBomba = -1; //a quina croqueta surt la bomba
    
    var cursors;

    var punts;
    var vides;

    var fotoPunts;
    var videsText;
    var fotoVides;

    var estat = 0; //estat del joc: 0 -> inici, 1 -> run, 2 -> perdre

    var game = new Phaser.Game(config);

    //pantallaInici
    var botoPlay;

    //pantallaFi
    var botoReiniciar;

    function preload ()
    {
        this.load.image('fons', 'assets/fons.png');
        this.load.image('formatge', 'assets/formatge.png');
        this.load.image('terra', 'assets/taula.png');
        this.load.image('fletxaDreta', 'assets/fletxaDreta.png');
        this.load.image('fletxaEsquerra', 'assets/fletxaEsquerra.png');
        this.load.image('tPunts', 'assets/textPunts.png');
        this.load.image('tVides', 'assets/textVides.png');
        this.load.image('croquetaQuieta', 'assets/croqueta_quieta.png');
        this.load.image('bombaNormal', 'assets/bombaNormal.png');
        
        this.load.image('entrepa0', 'assets/entrepa0.png');
        this.load.image('entrepa1', 'assets/entrepa1.png');
        this.load.image('entrepa2', 'assets/entrepa2.png');
        this.load.image('entrepa3', 'assets/entrepa3.png');
        this.load.image('entrepa4', 'assets/entrepa4.png');

        this.load.image('botoPlay', 'assets/botoPlay.png');
        this.load.image('botoReiniciar', 'assets/botoReiniciar.png');
        this.load.image('botoInstruccions', 'assets/botoInstruccions.png');

        this.load.spritesheet('croqueta', 'assets/croqueta.png', { frameWidth: 120, frameHeight: 120});        
    }    

    function create ()     {
        //FONS
        this.add.image(0, 0, 'fons').setOrigin(0, 0);
        
        //FORMATGE VIDES
        f1 = this.add.image(xFormatge+0*ampladaFormatge, yFormatge, 'formatge');
        f2 = this.add.image(xFormatge+1*ampladaFormatge, yFormatge, 'formatge');
        f3 = this.add.image(xFormatge+2*ampladaFormatge, yFormatge, 'formatge');
        f1.setScale(2);
        f2.setScale(2);
        f3.setScale(2);

        //CROQUETA
        croqueta = this.physics.add.sprite(100, 200, 'croqueta');
        croqueta.setCollideWorldBounds(true); 
        
        //TERRA (perdre)
        terra = this.physics.add.staticGroup();
        terra.create(750, 2220, 'terra');

        //ENTREPÃ€
        entrepa = this.physics.add.sprite(720, yEntrepa, 'entrepa0').setImmovable();
        entrepa.body.setAllowGravity(false); 
        entrepa.setScale(1.5);      

        //FLETXA DRETA
        fletxaDreta = this.add.sprite(1240, 2300, 'fletxaDreta').setInteractive();
        fletxaDreta.on('pointerdown', function () {            
            moureDreta();
        });
        fletxaDreta.setScale(3);

        //FLETXA ESQUERRA
        fletxaEsquerra = this.add.sprite(200, 2300, 'fletxaEsquerra').setInteractive();
        fletxaEsquerra.on('pointerdown', function () {            
            moureEsquerra();
        });
        fletxaEsquerra.setScale(3);

        //BOMBA
        bomba = this.physics.add.sprite(100, 200, 'bombaNormal');
        bomba.setCollideWorldBounds(true);
        bomba.setScale(5);
        bomba.body.gravity.y = 300;

        //FORMATGE
        formatge = this.physics.add.sprite(100, 200, 'formatge');
        formatge.setScale(2);
        formatge.setCollideWorldBounds(true);
        formatge.body.gravity.y = 200;

        //ANIMACIONS
        this.anims.create({
            key: 'croqueta',
            frames: this.anims.generateFrameNumbers('croqueta', { start: 0, end: 3 }),
            frameRate: 10,
            repeat: -1
        });   
        
        //CURSORS
        cursors = this.input.keyboard.createCursorKeys();        

        //COLLIDERS
        this.physics.add.collider(croqueta, terra, terraTocat);
        this.physics.add.collider(croqueta, entrepa, entrepaTocat);
        this.physics.add.collider(bomba, terra, bombaTerra);
        this.physics.add.collider(bomba, entrepa, bombaEntrepa);
        this.physics.add.collider(formatge, terra, formatgeTerra);
        this.physics.add.collider(formatge, entrepa, formatgeEntrepa);

        //TEXTS
        fotoPunts = this.add.image(180, 60, 'tPunts');
        fotoVides = this.add.image(180, 210, 'tVides');
        puntsText = this.add.text(340, 15, '0', { fontSize: '128px', fill: '#000' });
        fotoPunts.setScale(2);
        fotoVides.setScale(2);       

        //BOTO INICI
        botoPlay = this.add.sprite(720, 1250, 'botoPlay').setInteractive();
        botoPlay.setScale(5);
        botoPlay.on('pointerdown', function () {            
            inicialitzar();
        });

        //BOTO REINICIAR
        botoReiniciar = this.add.sprite(720, 1250, 'botoReiniciar').setInteractive();
        botoReiniciar.setScale(10);
        botoReiniciar.on('pointerdown', function () {
            pantallaInici();
        });
        botoReiniciar.visible = false;

        pantallaInici();
        croqueta.anims.play('croqueta', true);
    }

    function update () {
        if (estat == 1) {
            if (vides <= 0) {
                estat = 2;
                perdut();
            }
        }        
    }

    //PANTALLA INICI 
    function pantallaInici () {
        f1.visible = false;
        f2.visible = false;
        f3.visible = false;
        croqueta.visible = false;
        entrepa.visible = false;
        fletxaDreta.visible = false;
        fletxaEsquerra.visible = false;
        fotoPunts.visible = false;
        fotoVides.visible = false;
        puntsText.visible = false;
        botoReiniciar.visible = false;
        bomba.visible = false;
        bomba.body.enable = false;
        formatge.visible = false;
        formatge.body.enable = false;

        botoPlay.visible = true;
        botoReiniciar.visible = false;
    }

    //PANTALLA JOC
    function inicialitzar () {
        f1.visible = true;
        f2.visible = true;
        f3.visible = true;
        croqueta.visible = true;
        entrepa.visible = true;
        fletxaDreta.visible = true;
        fletxaEsquerra.visible = true;
        fotoPunts.visible = true;
        fotoVides.visible = true;
        puntsText.visible = true;

        botoPlay.visible = false;
        botoReiniciar.visible = false;
        bomba.visible = false;
        bomba.body.enable = false;

        countFormatge = maxFormatge;
        vides = 3;
        punts = 0; 
        nCroquetes = 0;
        timerBomba = getRandomInt(0, 4);
        spawnCroqueta();
        dibuixarEntrepa();
        
        estat = 1;
    }

    //PANTALLA HAS PERDUT
    function perdut () {
        f1.visible = false;
        f2.visible = false;
        f3.visible = false;
        croqueta.visible = false;
        terra.visible = false;
        entrepa.visible = false;
        fletxaDreta.visible = false;
        fletxaEsquerra.visible = false;
        fotoPunts.visible = false;
        fotoVides.visible = false;
        puntsText.visible = false;
        bomba.visible = false; 
        bomba.body.enable = false;   
        formatge.visible = false;
        formatge.body.enable = false;

        botoReiniciar.visible = true;
    }

    function moureDreta () {
        if (entrepa.x <= limitDreta)
                entrepa.x += movLateral;
    }
    
    function moureEsquerra () {
        if (entrepa.x >= limitEsquerra)
                entrepa.x -= movLateral;
    }    

    function spawnCroqueta () {
        
        --countFormatge;
        var aux;

        if (countFormatge <= 0) {
            croqueta.visible = false;
            croqueta.body.enable = false;

            formatge.visible = false;
            formatge.body.enable = true;
                    
            

            formatge.y = limitSuperior;
            gravetat = getRandomInt(minGravetat, maxGravetat);
            
            formatge.body.gravity.y = gravetat;
            
            
            aux = getRandomInt(limitEsquerra, limitDreta);
            formatge.x = aux;
            countFormatge = maxFormatge;

            //puntsText.setText("z");
        } else {
            croqueta.visible = true;
            croqueta.body.enable = true;

            croqueta.y = limitSuperior;
            gravetat = getRandomInt(minGravetat, maxGravetat);
            croqueta.body.gravity.y = gravetat;
            aux = getRandomInt(limitEsquerra, limitDreta);
            croqueta.x = aux;

            if (nCroquetes == timerBomba) spawnBomba(aux); 
        }               
    }

    function spawnBomba (xcroqueta) {
        bomba.y = limitSuperior;
        bomba.body.enable = true;
        bomba.visible = true;
        bomba.body.gravity.y = 300;
       
        
        var aux = getRandomInt(limitEsquerra, limitDreta);

        while (abs(aux-xcroqueta) <= 500) aux = getRandomInt(limitEsquerra, limitDreta);

        bomba.x = aux;
    }

    function bombaTerra () {
        bomba.visible = false;
        bomba.body.enable = false;
        bomba.y  = 50; 
        bomba.body.gravity.y = 0;               
    }

    function bombaEntrepa () {        
        bomba.visible = false;        
        bomba.body.enable = false;
        bomba.y = 50;
        bomba.body.gravity.y = 0;

        nCroquetes = 0;
        dibuixarEntrepa();
        punts = 0;
        puntsText.setText(punts);        
    }     

    function formatgeTerra () { 
        formatge.visible = false;
        formatge.y  = 50; 
        formatge.body.enable = false;  
        
        spawnCroqueta();
    }

    function formatgeEntrepa () {
        
        formatge.visible = false;  
        formatge.y = 50;      
        formatge.body.enable = false;       
        

        if (vides < 3) ++vides;
        dibuixarVides();

        spawnCroqueta();
    }

    function dibuixarVides () {
        if (vides == 3) {
            f1.visible = true;
            f2.visible = true;
            f3.visible = true;
        }
        else if (vides == 2) {
            f1.visible = true;
            f2.visible = true;
            f3.visible = false;
        } else if (vides == 1) {
            f1.visible = true;
            f2.visible = false;
            f3.visible = false;
        } else if (vides == 0) {
            f1.visible = false;
            f2.visible = false;
            f3.visible = false;
        }
    }

    function terraTocat () {
        spawnCroqueta();

        vides -= 1;
        dibuixarVides();       
    }

    function dibuixarEntrepa () {
        entrepa.setTexture(spritesEntrepa[nCroquetes]);
    }

    function entrepaTocat () {
        spawnCroqueta();

        minGravetat += 20;
        maxGravetat += 20;

        nCroquetes++;        

        if (nCroquetes == 5) {
            timerbomba = getRandomInt(0, 4);
            nCroquetes = 0;
            punts += 100;
            puntsText.setText(punts);
        }
        
        dibuixarEntrepa();
    }   

    function abs (n) {
        if (n < 0) return -1*n;
        else return n;
    }

    function getRandomInt (min, max) {
        return Math.floor(Math.random() * (max - min)) + min;
    }
    </script>

</body>
</html>